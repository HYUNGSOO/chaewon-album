<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïï®Î≤î Í¥ÄÎ¶¨ - Ï±ÑÏõêÏù¥Ïùò ÏÑ±Ïû• Ïï®Î≤î</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Nanum+Myeongjo:wght@400;700;800&family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --cream: #FAF7F0;
            --soft-beige: #E8DCC7;
            --warm-beige: #D4C4A8;
            --light-tan: #E5D9C5;
            --soft-tan: #DDD0BC;
            --text-dark: #4A4A4A;
            --text-light: #7A7A7A;
            --accent-beige: #C9B896;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--cream);
            color: var(--text-dark);
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-family: 'Jua', sans-serif;
            font-size: 2.5em;
            color: var(--text-dark);
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: var(--accent-beige);
            color: white;
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--warm-beige);
            color: var(--text-dark);
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid var(--warm-beige);
            border-radius: 12px;
            font-size: 1em;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid var(--warm-beige);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .view-btn.active {
            background: var(--accent-beige);
            color: white;
            border-color: var(--accent-beige);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .spinner {
            border: 4px solid var(--warm-beige);
            border-top: 4px solid var(--accent-beige);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* List View */
        .list-container {
            display: none;
        }

        .list-container.active {
            display: block;
        }

        .list-item {
            background: white;
            border: 2px solid var(--warm-beige);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            align-items: center;
            transition: all 0.3s;
            cursor: move;
        }

        .list-item:hover {
            border-color: var(--accent-beige);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .list-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .list-item.drag-over {
            border: 3px dashed var(--accent-beige);
            background: var(--light-tan);
        }

        .list-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }

        .list-item.drag-over {
            border: 3px dashed var(--accent-beige);
            background: var(--light-tan);
        }

        .list-thumbnail {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .list-info {
            flex: 1;
        }

        .list-filename {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .list-meta {
            color: var(--text-light);
            font-size: 0.95em;
            margin-bottom: 5px;
        }

        .list-caption {
            color: var(--text-dark);
            margin-top: 10px;
            padding: 10px;
            background: var(--light-tan);
            border-radius: 8px;
        }

        .list-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .btn-edit {
            background: var(--accent-beige);
            color: white;
        }

        .btn-delete {
            background: #f4d9d0;
            color: var(--text-dark);
        }

        /* Grid View */
        .grid-container {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .grid-container.active {
            display: grid;
        }

        .grid-item {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            padding: 15px;
            position: relative;
            cursor: move;
        }

        .grid-item:hover {
            transform: translateY(-5px);
        }

        .grid-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }

        .grid-item.drag-over {
            border: 3px dashed var(--accent-beige);
        }

        .grid-thumbnail {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
        }

        .grid-info {
            padding: 15px 5px;
        }

        .grid-date {
            font-size: 0.9em;
            color: var(--text-light);
            font-family: 'Nanum Myeongjo', serif;
        }

        .grid-caption {
            margin-top: 8px;
            font-size: 1em;
            color: var(--text-dark);
        }

        .grid-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .grid-actions button {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-family: 'Jua', sans-serif;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-dark);
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .modal-form label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .modal-form input, .modal-form textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--warm-beige);
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:hover {
            transform: scale(1.02);
        }

        .modal-btn-primary {
            background: var(--accent-beige);
            color: white;
        }

        .modal-btn-secondary {
            background: var(--warm-beige);
            color: var(--text-dark);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .list-item {
                flex-direction: column;
            }

            .list-thumbnail {
                width: 100%;
                height: 200px;
            }

            .list-actions {
                width: 100%;
            }

            .list-actions button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ†Ô∏è Ïï®Î≤î Í¥ÄÎ¶¨</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    ‚ûï ÏóÖÎ°úÎìú
                </button>
                <a href="index.html" class="btn btn-secondary">
                    ‚Üê Î©îÏù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </a>
            </div>
            <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display: none;">
        </header>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç ÌååÏùºÎ™Ö, ÏÑ§Î™Ö, ÎÇ†Ïßú Í≤ÄÏÉâ..." onkeyup="filterItems()">
            </div>
            <div class="view-toggle">
                <button class="view-btn" onclick="switchView('grid')" id="viewGridBtn">
                    üì± Í≤©Ïûê
                </button>
                <button class="view-btn active" onclick="switchView('list')" id="viewListBtn">
                    üìã Î¶¨Ïä§Ìä∏
                </button>
            </div>
            <div class="view-toggle">
                <button class="view-btn active" onclick="toggleSort()" id="sortBtn">
                    üìÖ ÏµúÏã†Ïàú
                </button>
            </div>
            <div style="color: var(--text-light);">
                Ï¥ù <span id="totalCount">0</span>Í∞ú
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>

        <div id="listContainer" class="list-container active"></div>
        <div id="gridContainer" class="grid-container"></div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ÏÇ¨ÏßÑ Ï†ïÎ≥¥ ÏàòÏ†ï</h3>
            <div class="modal-form">
                <div>
                    <label>ÎÇ†Ïßú</label>
                    <input type="date" id="editDate">
                </div>
                <div>
                    <label>ÏÑ§Î™Ö</label>
                    <input type="text" id="editCaption" placeholder="ÏÇ¨ÏßÑ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="closeEditModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn modal-btn-primary" onclick="saveEdit()">Ï†ÄÏû•</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Drive configuration - MUST BE SAME AS MAIN PAGE
        const GOOGLE_CLIENT_ID = '373129025440-4ats7v4ec2kvgtemdtbqdn5njmuud2n0.apps.googleusercontent.com';
        const GOOGLE_FOLDER_ID = '1OPv9ZA9tYuyVk1kxlqOYA7tosmRKE0S7';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let accessToken = null;
        let tokenClient;
        let galleryItems = [];
        let filteredItems = [];
        let currentView = 'list';
        let editingIndex = null;
        let draggedIndex = null;
        let draggedElement = null;
        let sortOrder = 'desc'; // 'desc' = ÏµúÏã†Ïàú (ÎÇ¥Î¶ºÏ∞®Ïàú), 'asc' = Ïò§ÎûòÎêúÏàú (Ïò§Î¶ÑÏ∞®Ïàú)

        // Initialize
        window.onload = function() {
            // Check if user is already logged in via opener window
            if (window.opener && window.opener.accessToken) {
                accessToken = window.opener.accessToken;
                loadData();
            } else {
                // Need to login
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: (tokenResponse) => {
                        accessToken = tokenResponse.access_token;
                        loadData();
                    },
                });
                tokenClient.requestAccessToken();
            }
        };

        const imageUrlCache = {};

        async function getAuthedImageUrl(driveUrl) {
            // Check cache first
            if (imageUrlCache[driveUrl]) {
                return imageUrlCache[driveUrl];
            }
            
            try {
                // Extract file ID from Drive URL
                const fileIdMatch = driveUrl.match(/\/files\/([^/?]+)/);
                if (!fileIdMatch) {
                    console.error('Invalid Drive URL:', driveUrl);
                    return null;
                }
                
                const fileId = fileIdMatch[1];
                
                // Use direct public download link
                const publicUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                imageUrlCache[driveUrl] = publicUrl;
                return publicUrl;
            } catch (e) {
                console.error('Ïù¥ÎØ∏ÏßÄ URL Î≥ÄÌôò Ïã§Ìå®:', e);
                return null;
            }
        }

        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                await loadConfigFile();
                await loadGalleryFiles();
                
                document.getElementById('totalCount').textContent = galleryItems.length;
                renderView();
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                alert('Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadConfigFile() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='chaewon_config.json' and '${GOOGLE_FOLDER_ID}' in parents&fields=files(id)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    const fileId = data.files[0].id;
                    const fileResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    
                    const config = await fileResponse.json();
                    return config.galleryMetadata || [];
                }
            } catch (error) {
                console.log('ÏÑ§Ï†ï ÌååÏùº ÏóÜÏùå');
            }
            return [];
        }

        async function loadGalleryFiles() {
            try {
                const response = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${GOOGLE_FOLDER_ID}' in parents and (mimeType contains 'image/' or mimeType contains 'video/')&fields=files(id,name,mimeType,createdTime)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                
                const data = await response.json();
                const galleryMeta = await loadConfigFile();
                
                if (data.files) {
                    galleryItems = data.files.map(file => {
                        const meta = galleryMeta.find(m => m.driveId === file.id);
                        return {
                            id: file.id,
                            type: file.mimeType.startsWith('image/') ? 'image' : 'video',
                            data: `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`,
                            date: meta?.date || file.createdTime,
                            caption: meta?.caption || '',
                            driveId: file.id
                        };
                    });
                    
                    // ÎÇ†ÏßúÏàú Ï†ïÎ†¨ (ÏµúÏã†Ïàú Í∏∞Î≥∏)
                    sortItems();
                }
            } catch (error) {
                console.error('Í∞§Îü¨Î¶¨ Î°úÎìú Ïã§Ìå®:', error);
            }
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('viewGridBtn').classList.toggle('active', view === 'grid');
            document.getElementById('viewListBtn').classList.toggle('active', view === 'list');
            renderView();
        }

        function toggleSort() {
            sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
            const sortBtn = document.getElementById('sortBtn');
            
            if (sortOrder === 'desc') {
                sortBtn.textContent = 'üìÖ ÏµúÏã†Ïàú';
                sortBtn.classList.add('active');
            } else {
                sortBtn.textContent = 'üìÖ Ïò§ÎûòÎêúÏàú';
                sortBtn.classList.remove('active');
            }
            
            sortItems();
            renderView();
        }

        function sortItems() {
            galleryItems.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                
                if (sortOrder === 'desc') {
                    return dateB - dateA; // ÏµúÏã†Ïàú (ÎÇ¥Î¶ºÏ∞®Ïàú)
                } else {
                    return dateA - dateB; // Ïò§ÎûòÎêúÏàú (Ïò§Î¶ÑÏ∞®Ïàú)
                }
            });
        }

        function filterItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                filteredItems = [];
            } else {
                filteredItems = galleryItems.filter(item => 
                    (item.caption || '').toLowerCase().includes(searchTerm) ||
                    new Date(item.date).toLocaleDateString('ko-KR').includes(searchTerm)
                );
            }
            
            renderView();
        }

        // Drag and Drop handlers
        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            draggedElement = e.currentTarget;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.list-item, .grid-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const dropTarget = e.target.closest('.list-item, .grid-item');
            if (dropTarget && dropTarget !== draggedElement) {
                dropTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            const dropTarget = e.target.closest('.list-item, .grid-item');
            if (dropTarget) {
                dropTarget.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropTarget = e.target.closest('.list-item, .grid-item');
            if (!dropTarget || dropTarget === draggedElement) return;
            
            const dropIndex = parseInt(dropTarget.dataset.index);
            
            if (draggedIndex !== null && !isNaN(dropIndex) && draggedIndex !== dropIndex) {
                // Get the container
                const container = dropTarget.parentNode;
                
                // Reorder DOM elements visually
                if (draggedIndex < dropIndex) {
                    // Moving down
                    dropTarget.parentNode.insertBefore(draggedElement, dropTarget.nextSibling);
                } else {
                    // Moving up
                    dropTarget.parentNode.insertBefore(draggedElement, dropTarget);
                }
                
                // Update data array
                const draggedItem = galleryItems[draggedIndex];
                galleryItems.splice(draggedIndex, 1);
                galleryItems.splice(dropIndex, 0, draggedItem);
                
                // Update all data-index attributes
                const items = container.querySelectorAll('.list-item, .grid-item');
                items.forEach((item, idx) => {
                    item.dataset.index = idx;
                });
                
                // Save to Drive in background
                saveMetadata().catch(err => console.error('Ï†ÄÏû• Ïã§Ìå®:', err));
            }
            
            dropTarget.classList.remove('drag-over');
        }

        async function renderView() {
            const items = filteredItems.length > 0 || document.getElementById('searchInput').value 
                ? filteredItems 
                : galleryItems;
            
            if (currentView === 'list') {
                await renderListView(items);
            } else {
                await renderGridView(items);
            }
        }

        async function renderListView(items) {
            const listContainer = document.getElementById('listContainer');
            const gridContainer = document.getElementById('gridContainer');
            
            listContainer.classList.add('active');
            gridContainer.classList.remove('active');
            listContainer.innerHTML = '';
            
            if (items.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
                return;
            }
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const actualIndex = galleryItems.indexOf(item);
                
                let mediaSrc = '';
                if (item.type === 'image' && item.data.startsWith('https://')) {
                    mediaSrc = await getAuthedImageUrl(item.data) || '';
                } else {
                    mediaSrc = item.data;
                }

                const div = document.createElement('div');
                div.className = 'list-item';
                div.draggable = true;
                div.dataset.index = actualIndex;
                
                // Add drag event listeners
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragleave', handleDragLeave);
                
                const thumbnail = item.type === 'image'
                    ? `<img src="${mediaSrc}" class="list-thumbnail" alt="Ïç∏ÎÑ§Ïùº">`
                    : `<video src="${mediaSrc}" class="list-thumbnail"></video>`;
                
                div.innerHTML = `
                    ${thumbnail}
                    <div class="list-info">
                        <div class="list-filename">${item.caption || `ÏÇ¨ÏßÑ ${actualIndex + 1}`}</div>
                        <div class="list-meta">üìÖ ${new Date(item.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        <div class="list-meta">üìÇ ${item.type === 'image' ? 'Ïù¥ÎØ∏ÏßÄ' : 'ÎèôÏòÅÏÉÅ'}</div>
                        <div class="list-meta">üÜî ${item.driveId}</div>
                        ${item.caption ? `<div class="list-caption">"${item.caption}"</div>` : ''}
                    </div>
                    <div class="list-actions">
                        <button class="action-btn btn-edit" onclick="editItem(${actualIndex})">‚úèÔ∏è ÏàòÏ†ï</button>
                        <button class="action-btn btn-delete" onclick="deleteItem(${actualIndex})">üóëÔ∏è ÏÇ≠Ï†ú</button>
                    </div>
                `;
                
                listContainer.appendChild(div);
            }
        }

        async function renderGridView(items) {
            const listContainer = document.getElementById('listContainer');
            const gridContainer = document.getElementById('gridContainer');
            
            listContainer.classList.remove('active');
            gridContainer.classList.add('active');
            gridContainer.innerHTML = '';
            
            if (items.length === 0) {
                gridContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-state-icon">üì≠</div>
                        <p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
                return;
            }
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const actualIndex = galleryItems.indexOf(item);
                
                let mediaSrc = '';
                if (item.type === 'image' && item.data.startsWith('https://')) {
                    mediaSrc = await getAuthedImageUrl(item.data) || '';
                } else {
                    mediaSrc = item.data;
                }

                const div = document.createElement('div');
                div.className = 'grid-item';
                div.draggable = true;
                div.dataset.index = actualIndex;
                
                // Add drag event listeners
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragleave', handleDragLeave);
                
                const mediaElement = item.type === 'image'
                    ? `<img src="${mediaSrc}" class="grid-thumbnail" alt="Ï±ÑÏõêÏù¥ ÏÇ¨ÏßÑ">`
                    : `<video src="${mediaSrc}" class="grid-thumbnail" controls></video>`;
                
                div.innerHTML = `
                    ${mediaElement}
                    <div class="grid-info">
                        <div class="grid-date">${new Date(item.date).toLocaleDateString('ko-KR')}</div>
                        <div class="grid-caption">${item.caption || 'ÏÜåÏ§ëÌïú ÏàúÍ∞Ñ'}</div>
                        <div class="grid-actions">
                            <button class="action-btn btn-edit" onclick="editItem(${actualIndex})">‚úèÔ∏è</button>
                            <button class="action-btn btn-delete" onclick="deleteItem(${actualIndex})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                gridContainer.appendChild(div);
            }
        }

        function editItem(index) {
            editingIndex = index;
            const item = galleryItems[index];
            
            document.getElementById('editDate').value = item.date.split('T')[0];
            document.getElementById('editCaption').value = item.caption || '';
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            editingIndex = null;
        }

        async function saveEdit() {
            if (editingIndex === null) return;
            
            const date = document.getElementById('editDate').value;
            const caption = document.getElementById('editCaption').value;
            
            if (!date) {
                alert('ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            galleryItems[editingIndex].date = new Date(date).toISOString();
            galleryItems[editingIndex].caption = caption;
            
            await saveMetadata();
            sortItems(); // Ï†ïÎ†¨ ÌõÑ Îã§Ïãú Î†åÎçîÎßÅ
            renderView();
            closeEditModal();
        }

        async function deleteItem(index) {
            if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†Ïñ¥Ïöî?')) return;
            
            const item = galleryItems[index];
            
            try {
                await fetch(`https://www.googleapis.com/drive/v3/files/${item.driveId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                galleryItems.splice(index, 1);
                await saveMetadata();
                
                document.getElementById('totalCount').textContent = galleryItems.length;
                renderView();
            } catch (error) {
                console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }

        async function saveMetadata() {
            const galleryMeta = galleryItems.map(item => ({
                id: item.id || Date.now() + Math.random(),
                driveId: item.driveId,
                date: item.date,
                caption: item.caption
            }));
            
            try {
                // Load existing config to preserve milestone photos and timeline
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=name='chaewon_config.json' and '${GOOGLE_FOLDER_ID}' in parents&fields=files(id)`,
                    { headers: { 'Authorization': `Bearer ${accessToken}` } }
                );
                
                const searchData = await searchResponse.json();
                
                let config = { galleryMetadata: galleryMeta };
                
                if (searchData.files && searchData.files.length > 0) {
                    const fileId = searchData.files[0].id;
                    
                    // Load existing config
                    const existingResponse = await fetch(
                        `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
                        { headers: { 'Authorization': `Bearer ${accessToken}` } }
                    );
                    
                    try {
                        const existingConfig = await existingResponse.json();
                        // Preserve milestone photos and timeline
                        config.milestonePhotos = existingConfig.milestonePhotos || {};
                        config.timelineEvents = existingConfig.timelineEvents || [];
                    } catch(e) {
                        console.log('Í∏∞Ï°¥ ÏÑ§Ï†ï ÌååÏùº ÌååÏã± Ïã§Ìå®');
                    }
                    
                    // Update with new gallery metadata
                    config.galleryMetadata = galleryMeta;
                    
                    const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
                    const metadata = {
                        name: 'chaewon_config.json',
                        mimeType: 'application/json'
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`,
                        {
                            method: 'PATCH',
                            headers: { 'Authorization': `Bearer ${accessToken}` },
                            body: form
                        }
                    );
                } else {
                    // Create new file
                    const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
                    const metadata = {
                        name: 'chaewon_config.json',
                        mimeType: 'application/json',
                        parents: [GOOGLE_FOLDER_ID]
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${accessToken}` },
                            body: form
                        }
                    );
                }
                
                console.log('Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû• ÏÑ±Í≥µ!');
            } catch (error) {
                console.error('Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        }

        // File upload
        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressed);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function uploadToGoogleDrive(file, compressedData) {
            try {
                const metadata = {
                    name: `chaewon_${Date.now()}_${file.name}`,
                    mimeType: file.type,
                    parents: [GOOGLE_FOLDER_ID]
                };
                
                const base64Data = compressedData.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: file.type });
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType,createdTime',
                    {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${accessToken}` },
                        body: form
                    }
                );
                
                if (!response.ok) throw new Error('ÏóÖÎ°úÎìú Ïã§Ìå®');
                
                return await response.json();
            } catch (error) {
                console.error('ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                throw error;
            }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = e.target.files;
            document.getElementById('loading').style.display = 'block';
            
            for (let file of files) {
                try {
                    if (file.type.startsWith('image/')) {
                        const compressed = await compressImage(file);
                        const uploadedFile = await uploadToGoogleDrive(file, compressed);
                        
                        galleryItems.push({
                            id: uploadedFile.id,
                            type: 'image',
                            data: `https://www.googleapis.com/drive/v3/files/${uploadedFile.id}?alt=media`,
                            date: uploadedFile.createdTime,
                            caption: '',
                            driveId: uploadedFile.id
                        });
                    }
                } catch (error) {
                    console.error('ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                    alert('ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
                }
            }
            
            document.getElementById('loading').style.display = 'none';
            sortItems(); // ÏóÖÎ°úÎìú ÌõÑ Ï†ïÎ†¨
            document.getElementById('totalCount').textContent = galleryItems.length;
            renderView();
            e.target.value = '';
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        };
    </script>
</body>
</html>